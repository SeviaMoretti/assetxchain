#![cfg(feature = "runtime-benchmarks")]

use super::*;

use codec::Encode;
use frame_benchmarking::{benchmarks, account, whitelisted_caller};
use frame_system::RawOrigin;
use frame_support::{
	pallet_prelude::Weight,
	traits::{Currency, Get, ReservableCurrency},
};
use frame_system::pallet_prelude::BlockNumberFor;
use sp_runtime::traits::{Bounded, StaticLookup, SaturatedConversion};
use sp_std::vec;
use sp_std::vec::Vec;

use pallet_contracts::{CollectEvents, DebugInfo, Determinism, Code};

type BalanceOf<T> = <<T as pallet::Config>::Currency as Currency<<T as frame_system::Config>::AccountId>>::Balance;

const REAL_MARKET_WASM: &[u8] = &[
	0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x26, 0x07, 0x60, 0x03, 0x7f, 0x7f, 0x7f, 0x01, 0x7f, 0x60, 0x00, 0x00, 0x60, 0x04, 0x7f, 0x7f, 0x7f, 0x7f, 0x01, 0x7f, 0x60, 0x02, 0x7f, 0x7f, 0x00, 0x60, 0x01, 0x7f, 0x00, 0x60, 0x03, 0x7f, 0x7f, 0x7f, 0x00, 0x60, 0x00, 0x01, 0x7f, 0x02, 0x74, 0x06, 0x05, 0x73, 0x65, 0x61, 0x6c, 0x31, 0x0b, 0x67, 0x65, 0x74, 0x5f, 0x73, 0x74, 0x6f, 0x72, 0x61, 0x67, 0x65, 0x00, 0x02, 0x05, 0x73, 0x65, 0x61, 0x6c, 0x30, 0x05, 0x69, 0x6e, 0x70, 0x75, 0x74, 0x00, 0x03, 0x05, 0x73, 0x65, 0x61, 0x6c, 0x30, 0x0b, 0x73, 0x65, 0x61, 0x6c, 0x5f, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x00, 0x05, 0x05, 0x73, 0x65, 0x61, 0x6c, 0x32, 0x0b, 0x73, 0x65, 0x74, 0x5f, 0x73, 0x74, 0x6f, 0x72, 0x61, 0x67, 0x65, 0x00, 0x02, 0x05, 0x73, 0x65, 0x61, 0x6c, 0x30, 0x11, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x5f, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x66, 0x65, 0x72, 0x72, 0x65, 0x64, 0x00, 0x03, 0x03, 0x65, 0x6e, 0x76, 0x06, 0x6d, 0x65, 0x6d, 0x6f, 0x72, 0x79, 0x02, 0x01, 0x02, 0x10, 0x03, 0x0b, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x04, 0x01, 0x04, 0x01, 0x06, 0x16, 0x03, 0x7f, 0x01, 0x41, 0x80, 0x80, 0x04, 0x0b, 0x7f, 0x00, 0x41, 0x80, 0x80, 0x05, 0x0b, 0x7f, 0x00, 0x41, 0x80, 0x80, 0x05, 0x0b, 0x07, 0x11, 0x02, 0x04, 0x63, 0x61, 0x6c, 0x6c, 0x00, 0x09, 0x06, 0x64, 0x65, 0x70, 0x6c, 0x6f, 0x79, 0x00, 0x0e, 0x0a, 0xcc, 0x06, 0x0a, 0x3f, 0x01, 0x02, 0x7f, 0x03, 0x40, 0x20, 0x02, 0x45, 0x04, 0x40, 0x41, 0x00, 0x0f, 0x0b, 0x20, 0x02, 0x41, 0x01, 0x6b, 0x21, 0x02, 0x20, 0x01, 0x2d, 0x00, 0x00, 0x21, 0x03, 0x20, 0x00, 0x2d, 0x00, 0x00, 0x21, 0x04, 0x20, 0x01, 0x41, 0x01, 0x6a, 0x21, 0x01, 0x20, 0x00, 0x41, 0x01, 0x6a, 0x21, 0x00, 0x20, 0x03, 0x20, 0x04, 0x46, 0x0d, 0x00, 0x0b, 0x20, 0x04, 0x20, 0x03, 0x6b, 0x0b, 0x2b, 0x01, 0x01, 0x7f, 0x03, 0x7f, 0x20, 0x02, 0x20, 0x03, 0x46, 0x04, 0x7f, 0x20, 0x00, 0x05, 0x20, 0x00, 0x20, 0x03, 0x6a, 0x20, 0x01, 0x20, 0x03, 0x6a, 0x2d, 0x00, 0x00, 0x3a, 0x00, 0x00, 0x20, 0x03, 0x41, 0x01, 0x6a, 0x21, 0x03, 0x0c, 0x01, 0x0b, 0x0b, 0x0b, 0x6f, 0x01, 0x01, 0x7f, 0x02, 0x40, 0x20, 0x00, 0x20, 0x01, 0x4d, 0x04, 0x40, 0x20, 0x00, 0x21, 0x03, 0x03, 0x40, 0x20, 0x02, 0x45, 0x0d, 0x02, 0x20, 0x03, 0x20, 0x01, 0x2d, 0x00, 0x00, 0x3a, 0x00, 0x00, 0x20, 0x03, 0x41, 0x01, 0x6a, 0x21, 0x03, 0x20, 0x01, 0x41, 0x01, 0x6a, 0x21, 0x01, 0x20, 0x02, 0x41, 0x01, 0x6b, 0x21, 0x02, 0x0c, 0x00, 0x0b, 0x00, 0x0b, 0x20, 0x00, 0x41, 0x01, 0x6b, 0x21, 0x03, 0x20, 0x01, 0x41, 0x01, 0x6b, 0x21, 0x01, 0x03, 0x40, 0x20, 0x02, 0x45, 0x0d, 0x01, 0x20, 0x02, 0x20, 0x03, 0x6a, 0x20, 0x01, 0x20, 0x02, 0x6a, 0x2d, 0x00, 0x00, 0x3a, 0x00, 0x00, 0x20, 0x02, 0x41, 0x01, 0x6b, 0x21, 0x02, 0x0c, 0x00, 0x0b, 0x00, 0x0b, 0x20, 0x00, 0x0b, 0x25, 0x01, 0x01, 0x7f, 0x03, 0x7f, 0x20, 0x02, 0x20, 0x03, 0x46, 0x04, 0x7f, 0x20, 0x00, 0x05, 0x20, 0x00, 0x20, 0x03, 0x6a, 0x20, 0x01, 0x3a, 0x00, 0x00, 0x20, 0x03, 0x41, 0x01, 0x6a, 0x21, 0x03, 0x0c, 0x01, 0x0b, 0x0b, 0x0b, 0xc8, 0x01, 0x01, 0x05, 0x7f, 0x23, 0x00, 0x41, 0x10, 0x6b, 0x22, 0x00, 0x24, 0x00, 0x02, 0x40, 0x02, 0x40, 0x02, 0x40, 0x10, 0x0a, 0x41, 0xff, 0x01, 0x71, 0x41, 0x05, 0x47, 0x0d, 0x00, 0x20, 0x00, 0x41, 0x80, 0x80, 0x01, 0x36, 0x02, 0x04, 0x41, 0x80, 0x80, 0x04, 0x20, 0x00, 0x41, 0x04, 0x6a, 0x22, 0x03, 0x10, 0x01, 0x20, 0x00, 0x28, 0x02, 0x04, 0x22, 0x01, 0x41, 0x81, 0x80, 0x01, 0x4f, 0x0d, 0x00, 0x20, 0x01, 0x41, 0x04, 0x49, 0x0d, 0x01, 0x41, 0x80, 0x80, 0x04, 0x28, 0x02, 0x00, 0x41, 0xa6, 0xfc, 0xcc, 0xa2, 0x03, 0x47, 0x0d, 0x01, 0x20, 0x00, 0x42, 0x80, 0x80, 0x01, 0x37, 0x02, 0x08, 0x20, 0x00, 0x41, 0x80, 0x80, 0x04, 0x36, 0x02, 0x04, 0x20, 0x03, 0x10, 0x0b, 0x20, 0x00, 0x28, 0x02, 0x08, 0x22, 0x02, 0x20, 0x00, 0x28, 0x02, 0x0c, 0x22, 0x01, 0x49, 0x0d, 0x00, 0x20, 0x00, 0x28, 0x02, 0x04, 0x21, 0x04, 0x20, 0x00, 0x20, 0x02, 0x20, 0x01, 0x6b, 0x22, 0x02, 0x36, 0x02, 0x04, 0x20, 0x04, 0x20, 0x01, 0x20, 0x01, 0x20, 0x04, 0x6a, 0x20, 0x03, 0x10, 0x00, 0x20, 0x00, 0x28, 0x02, 0x04, 0x22, 0x00, 0x20, 0x02, 0x4b, 0x72, 0x0d, 0x00, 0x20, 0x00, 0x45, 0x0d, 0x02, 0x0b, 0x00, 0x0b, 0x10, 0x0c, 0x00, 0x0b, 0x41, 0x80, 0x80, 0x04, 0x41, 0x80, 0x02, 0x3b, 0x01, 0x00, 0x41, 0x00, 0x10, 0x0d, 0x00, 0x0b, 0x59, 0x02, 0x01, 0x7f, 0x02, 0x7e, 0x23, 0x00, 0x41, 0x20, 0x6b, 0x22, 0x00, 0x24, 0x00, 0x20, 0x00, 0x42, 0x00, 0x37, 0x03, 0x08, 0x20, 0x00, 0x42, 0x00, 0x37, 0x03, 0x00, 0x20, 0x00, 0x41, 0x10, 0x36, 0x02, 0x1c, 0x20, 0x00, 0x20, 0x00, 0x41, 0x1c, 0x6a, 0x10, 0x04, 0x20, 0x00, 0x28, 0x02, 0x1c, 0x41, 0x11, 0x4f, 0x04, 0x40, 0x00, 0x0b, 0x20, 0x00, 0x29, 0x03, 0x08, 0x21, 0x01, 0x20, 0x00, 0x29, 0x03, 0x00, 0x21, 0x02, 0x20, 0x00, 0x41, 0x20, 0x6a, 0x24, 0x00, 0x41, 0x05, 0x41, 0x04, 0x20, 0x01, 0x20, 0x02, 0x84, 0x50, 0x1b, 0x0b, 0x5c, 0x01, 0x04, 0x7f, 0x23, 0x00, 0x41, 0x10, 0x6b, 0x22, 0x01, 0x24, 0x00, 0x20, 0x01, 0x41, 0x00, 0x36, 0x02, 0x0c, 0x20, 0x01, 0x41, 0x0c, 0x6a, 0x21, 0x04, 0x02, 0x40, 0x02, 0x40, 0x20, 0x00, 0x28, 0x02, 0x08, 0x22, 0x02, 0x41, 0x04, 0x6a, 0x22, 0x03, 0x20, 0x02, 0x49, 0x0d, 0x00, 0x20, 0x03, 0x20, 0x00, 0x28, 0x02, 0x04, 0x4b, 0x0d, 0x00, 0x20, 0x00, 0x28, 0x02, 0x00, 0x20, 0x02, 0x6a, 0x20, 0x04, 0x41, 0x04, 0x10, 0x06, 0x1a, 0x20, 0x00, 0x20, 0x03, 0x36, 0x02, 0x08, 0x0c, 0x01, 0x0b, 0x00, 0x0b, 0x20, 0x01, 0x41, 0x10, 0x6a, 0x24, 0x00, 0x0b, 0x11, 0x00, 0x41, 0x80, 0x80, 0x04, 0x41, 0x81, 0x02, 0x3b, 0x01, 0x00, 0x41, 0x01, 0x10, 0x0d, 0x00, 0x0b, 0x0d, 0x00, 0x20, 0x00, 0x41, 0x80, 0x80, 0x04, 0x41, 0x02, 0x10, 0x02, 0x00, 0x0b, 0xa6, 0x01, 0x01, 0x03, 0x7f, 0x23, 0x00, 0x41, 0x10, 0x6b, 0x22, 0x00, 0x24, 0x00, 0x02, 0x40, 0x02, 0x40, 0x02, 0x40, 0x10, 0x0a, 0x41, 0xff, 0x01, 0x71, 0x41, 0x05, 0x47, 0x0d, 0x00, 0x20, 0x00, 0x41, 0x80, 0x80, 0x01, 0x36, 0x02, 0x04, 0x41, 0x80, 0x80, 0x04, 0x20, 0x00, 0x41, 0x04, 0x6a, 0x22, 0x01, 0x10, 0x01, 0x20, 0x00, 0x28, 0x02, 0x04, 0x22, 0x02, 0x41, 0x81, 0x80, 0x01, 0x4f, 0x0d, 0x00, 0x20, 0x02, 0x41, 0x04, 0x49, 0x0d, 0x01, 0x41, 0x80, 0x80, 0x04, 0x28, 0x02, 0x00, 0x41, 0x9b, 0xdd, 0xf6, 0xf4, 0x05, 0x47, 0x0d, 0x01, 0x20, 0x00, 0x42, 0x80, 0x80, 0x01, 0x37, 0x02, 0x08, 0x20, 0x00, 0x41, 0x80, 0x80, 0x04, 0x36, 0x02, 0x04, 0x20, 0x01, 0x10, 0x0b, 0x20, 0x00, 0x28, 0x02, 0x0c, 0x22, 0x01, 0x20, 0x00, 0x28, 0x02, 0x08, 0x4d, 0x0d, 0x02, 0x0b, 0x00, 0x0b, 0x10, 0x0c, 0x00, 0x0b, 0x20, 0x00, 0x28, 0x02, 0x04, 0x22, 0x00, 0x20, 0x01, 0x20, 0x00, 0x20, 0x01, 0x6a, 0x41, 0x00, 0x10, 0x03, 0x1a, 0x41, 0x80, 0x80, 0x04, 0x41, 0x00, 0x3b, 0x01, 0x00, 0x41, 0x00, 0x10, 0x0d, 0x00, 0x0b,
];

benchmarks! {
	// 真实部署合约并注册市场
	register_market {
        let caller: T::AccountId = whitelisted_caller();
        
		// 准备资金
        let total_funding = <<T as pallet::Config>::Currency as Currency<T::AccountId>>::minimum_balance() * 1000000u32.into();
        <<T as pallet::Config>::Currency as Currency<T::AccountId>>::make_free_balance_be(&caller, total_funding);

        // 上传代码
        let wasm = REAL_MARKET_WASM.to_vec();
        let upload_result = pallet_contracts::Pallet::<T>::bare_upload_code(
            caller.clone(),
            wasm,
            None,
            Determinism::Enforced,
        ).map_err(|e| e)?;
        let code_hash = upload_result.code_hash;

        // 实例化合约 (准备构造函数数据)
        // ink! 默认 new() 构造函数的选择器通常是 0xed4b9d1b
        let constructor_selector: Vec<u8> = vec![0x9b, 0xae, 0x9d, 0x5e];
        let endowment: u128 = 0;
		let salt = caller.encode();

        let instantiate_result = pallet_contracts::Pallet::<T>::bare_instantiate(
            caller.clone(),
            endowment.saturated_into::<u128>().saturated_into(),
            Weight::MAX,
            None,
            Code::Existing(code_hash),
            constructor_selector, // 传入构造函数选择器
            salt,
            DebugInfo::Skip,
            CollectEvents::Skip,
        );

        let instantiate_res = instantiate_result.result.map_err(|e| {
            e 
        })?;
        let contract_address = instantiate_res.account_id;
        let asset_type = MarketAssetType::DataAsset;

    }: _(RawOrigin::Signed(caller.clone()), contract_address.clone(), asset_type)
    verify {
        assert!(RegisteredMarkets::<T>::contains_key(&contract_address));
    }

	unregister_market {
		let caller: T::AccountId = whitelisted_caller();
		let contract_address: T::AccountId = account("contract", 0, 0);
		let asset_type = MarketAssetType::DataAsset;

		let info = MarketRegistryInfo {
			creator: caller.clone(),
			contract_address: contract_address.clone(),
			asset_type,
			status: MarketStatus::Active,
		};
		RegisteredMarkets::<T>::insert(&contract_address, info);

	}: _(RawOrigin::Signed(caller), contract_address.clone())
	verify {
		assert!(!RegisteredMarkets::<T>::contains_key(&contract_address));
	}

	impl_benchmark_test_suite!(Pallet, crate::mock::new_test_ext(), crate::mock::Test);
}